<link type="text/css" rel="stylesheet" href="/css/jquery-ui.css">
<link type="text/css" rel="stylesheet" href="/css/jquery-ui.min.css">
<style>
table, td {
    border: 1px solid #aaa;
}
</style>
<script type="text/javascript">
    var allUsers;
    var dialogEdit;
    var dialogDelete;
    jQuery().ready(function(){
        loadUsers();
        $.ajax({
            url:'/admin/serchPerfil',
            type:'POST',
            success: function (data, textStatus, jqXHR) {
                        var options = '';
                        $.each(data.Options,function(i,item){
                            options += '<option value="'+item.Value+'">'+item.DisplayText+'</option>';
                        });
                        $('#profiles').append(options);
                        }        });
        $.ajax({
            url:'/admin/permisoUsuario',
            type:'POST',
            success: function (data, textStatus, jqXHR) {
                        var options = '';
                        $.each(data.Options,function(i,item){
                            options += item.DisplayText+'<input type="checkbox" value="'+item.Value+'" name="permisos[]"/>&nbsp;';
                        });
                        $('#form-dialog').append(options);
                        },
            error: function (jqXHR, textStatus, errorThrown) {
                        
                        }
        });
        dialogEdit = $('#dialog-edit').dialog({
            autoOpen:false,
            //height: 350,
            width: 298,
            resizable:false,
            modal:true,
            draggable:false,
            buttons:{
                "Guardar":editUser,
                Cancelar:function(){
                    dialogEdit.dialog("close");
                }
            },
            close: function() {
                $('#form-dialog')[0].reset();
            }
        });
        dialogDelete = $("#deleteDiv").dialog({
            autoOpen:false,
            resizable:false,
            modal:true,
            draggable:false,
            buttons:{
                "Eliminar":deletUser,
                Cancelar:function(){
                    dialogDelete.dialog("close");
                }
            }
        });
        
    });
    
    function loadUsers(){
        $.ajax({
            url:'/admin/listaUsuario',
            type:'POST',
            beforeSend: function (xhr) {
                            $('#titleTable').html('<img src="/img/loaderUser.gif">');
                        },
            success: function (data, textStatus, jqXHR) {
                            $('#titleTable').html('Lista de Usuarios');
                            var textTable = '';
                            var permiso = '';
                            var editDelete = '';
                            $('#listUser').html('');
                            allUsers = data;
                            if(allUsers.Records.length > 0){
                                $.each(data.Records,function (i,item){
                                    textTable = '<tr><td>'+item.Nombre+'</td><td>'+item.Apellido+'</td><td>'+item.Correo+'</td><td>'+item.perfil+'</td>';
                                    $.each(item.permisos,function(i,itemP){
                                        permiso += itemP.permiso+',';
                                    });
                                    permiso=permiso.slice(0,-1);
                                    editDelete = '<td style="width: 2%;"><img id="'+item.Id+'" style="cursor: pointer" class="icon-pencil"></i></td><td style="width: 2%;"><img id="'+item.Id+'" style="cursor: pointer" class="icon-trash"></i></td>';
                                    $('#listUser').append(textTable+'<td>'+permiso+'</td>'+editDelete+'</tr>');
                                    textTable = '';
                                    permiso = '';
                                    editDelete = '';
                                });
                                $("td > img").click(function (){
                                    if(this.getAttribute('class') === 'icon-pencil'){
                                        editDialog(this.id);
                                    }
                                    if(this.getAttribute('class') === 'icon-trash'){
                                        deletDialog(this.id);
                                    }
                                });
                            }else{
                                $('#listUser').append('<tr><td colspan="6" style="text-align:center">No existen usuarios</td></tr>');
                            }
                        },
            error: function (jqXHR, textStatus, errorThrown) {
                            alert('Estamos presentando inconvenientes de conexion');
                        }
        });
    }
    
    function editDialog(data){
        var formD = $('#form-dialog')[0];
        $.each(allUsers.Records,function(i,item){
            if(item.Id == data){
                formD[0].value = item.Id;
                formD[1].value = item.Nombre;
                formD[2].value = item.Apellido;
                formD[3].value = item.Correo;
                $.each(formD[4].options,function(i,itemPerf){
                    if(itemPerf.text == item.perfil){
                        formD[4].value = i+1;
                    }
                });
                $.each(item.permisos,function(i,itemPer){
                    for(var i=4;i<9;i++){
                        if(itemPer.Id == formD[i].value){
                            formD[i].checked = true;
                        }
                    }
                });
            }
        });
        dialogEdit.dialog('open');
    }
    
    function deletDialog(data){
        $("#deleteDiv p").attr('id',data);
        dialogDelete.dialog('open');
    }
    function deletUser(){
        $.ajax({
            url:'/admin/delete',
            type:'POST',
            dataType:'json',
            data:{'Id':$("#deleteDiv p").attr('id')},
            success: function (data, textStatus, jqXHR) {
                        loadUsers();
                        $("#deleteDiv").dialog('close');
                    },
            error: function (jqXHR, textStatus, errorThrown) {
                        
                    }
        });
    }
    function editUser(){
        var editData = JSON.parse(JSON.stringify($('#form-dialog').serializeArray()));
        $.ajax({
            url: "/admin/edit",
            type: 'POST',
            dataType: 'json',
            data: editData,
            success: function (data, textStatus, jqXHR) {
                        loadUsers();
                        $('#form-dialog')[0].reset();
                        dialogEdit.dialog('close');
                    },
            error: function (jqXHR, textStatus, errorThrown) {
                        alert("no se ha enviado bien");
                    }
        });
    }
</script>
    <h2>Edicion de Usuarios</h2>
    <div id="titleTable" style="width: 100%;background-color: #0b67cd;color: #FFFFFF;font: 900 larger sans-serif;height: 30px;vertical-align: middle" >
        &nbsp;
    </div>
    <table id="listUser" cellpadding="10" style="width: 100%">
        <thead style="background-color: #2d89ef;color: #FFFFFF">
            <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Correo</th>
                <th>Perfil</th>
                <th>Permisos</th>
                <th colspan="2"></th>
            </tr>
        </thead>
    </table>
    <div id="dialog-edit" title="Editar Usuario">
        <form id="form-dialog" class="form-horizontal">
            <input type="hidden" name="Id">
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" name="nombre">
            </div>
            <div class="form-group">
                <label>Apellido</label>
                <input type="text" name="apellido">
            </div>
            <div class="form-group">
                <label>Correo</label>
                <input type="text" name="correo">
            </div>
            <div class="form-group">
                <label>Perfil</label>
                <select id="profiles" name="perfil">
                    <option value="">--Seleccione Perfil--</option>
                </select>
            </div>
            <hr>
            <label>Permisos</label>
        </form>
    </div>
    <div id="deleteDiv" title="Â¿Desea borrar el usuario?">
        <p>&iquest;Esta seguro que desea eliminar al usuario?</p>
    </div>